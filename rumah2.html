<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dasar Lemah 2D</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --accent2: #a78bfa;
      --danger: #ef4444;
      --ok: #10b981;
    }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 20% 20%, #0b1324, #0a1020 60%, #070b18);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      line-height: 1.6;
      padding: 24px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
    }
    .back-home {
      text-align: right;
      margin-bottom: 16px;
    }
    .back-home a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    h1 {
      text-align: center;
      font-size: 1.6rem;
      margin: 0 0 20px;
      letter-spacing: 0.2px;
    }
    .card {
      background: linear-gradient(180deg, #121826, #0f1624);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }
    input[type="text"],
    select {
      width: 100%;
      background: #0c1220;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s ease;
    }
    input[type="text"]::placeholder {
      color: #6b7280;
    }
    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.12);
    }
    .input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 14px 0;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #0b1020;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }
    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    .btn-secondary {
      background: #0c1220;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .btn-delete {
      background: linear-gradient(90deg, var(--danger), #f87171);
      color: #0b1020;
    }
    .btn-edit {
      background: linear-gradient(90deg, #FF9800, #FFB347);
      color: #0b1020;
    }
    .result {
      margin-top: 16px;
      padding: 14px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      display: none;
    }
    .status {
      text-align: center;
      min-height: 24px;
      margin: 12px 0;
      font-weight: 600;
    }
    .success { color: var(--ok); }
    .error { color: var(--danger); }
    .saved-list {
      margin-top: 20px;
    }
    .saved-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .saved-item:last-child {
      border-bottom: none;
    }
    .saved-item button {
      background: var(--ok);
      color: #0b1020;
      padding: 4px 10px;
      font-size: 0.85rem;
      border-radius: 6px;
    }
    select {
      appearance: none;
      background-image: url("image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 36px;
    }
    #market-status {
      text-align: center;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 14px;
    }
    .summary-box {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
    }
    .summary-content {
      background: #0c1220;
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back-home">
      <a href="index.html">‚Üê Kembali ke Beranda</a>
    </div>

    <h1>Dasar Lemah 2D</h1>
    <div id="market-status"></div>

    <div class="card">
      <div style="margin-bottom: 16px;">
        <label for="marketSelect">Pilih Market</label>
        <select id="marketSelect">
          <option value="">-- Pilih Market --</option>
          <option value="Cambodia">Cambodia</option>
          <option value="Sidney">Sidney</option>
          <option value="China">China</option>
          <option value="Japan">Japan</option>
          <option value="SGP">SGP</option>
          <option value="Taiwan">Taiwan</option>
          <option value="Hongkong">Hongkong</option>
          <option value="Nusa">Nusa</option>
        </select>
      </div>

      <div class="input-group">
        <div>
          <label for="resultSebelum">Result Sebelumnya (4D)</label>
          <input type="text" id="resultSebelum" placeholder="Contoh: 1234" maxlength="4" />
        </div>
        <div>
          <label for="resultSekarang">Result Sekarang (4D)</label>
          <input type="text" id="resultSekarang" placeholder="Contoh: 9076" maxlength="4" />
        </div>
      </div>

      <div class="btn-row">
        <button id="btnCari">Cari</button>
        <button class="btn-secondary" id="btnEdit">Edit</button>
        <button id="btnSimpan">Simpan ke Cloud</button>
        <button class="btn-delete" id="btnHapus">Hapus dari Cloud</button>
        <button id="btnMuatDariRumah1" class="btn-secondary">Muat dari rumah1</button>
      </div>

      <div id="status" class="status"></div>

      <div id="resultBox" class="result" style="display: none;">
        <div>Kunci 2D (kop): <strong id="show2D">--</strong></div>
        <div>Dasar Lemah: <span id="showDasar">--</span></div>
      </div>
    </div>

    <div class="card saved-list" id="savedList">
      <h3>Data Tersimpan</h3>
      <p><em>Pilih market untuk memuat data.</em></p>
    </div>

    <!-- BLOK RANGKUMAN AKHIR -->
    <div class="card summary-box">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3>Rangkuman: Dasar Kuat (Bukan Lemah)</h3>
        <button class="btn-secondary" id="btnSalinRangkuman" style="padding: 6px 12px; font-size: 0.9rem;">Salin</button>
      </div>
      <div class="summary-content" id="rangkumanTidakLemah">Klik "Cari" untuk menghasilkan rangkuman.</div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="./config-firebase.js"></script>

  <script>
    // === FUNGSI BANTU ===
    function hitungDasar2D(duaD) {
      let total = duaD < 10 ? duaD : Math.floor(duaD / 10) + (duaD % 10);
      while (total >= 10) total = Math.floor(total / 10) + (total % 10);
      return total === 0 ? 9 : total;
    }

    function SeededRandom(seed) {
      this.seed = seed % 2147483647;
      if (this.seed <= 0) this.seed += 2147483646;
    }
    SeededRandom.prototype.next = function() {
      return this.seed = this.seed * 16807 % 2147483647;
    };
    SeededRandom.prototype.random = function() {
      return (this.next() - 1) / 2147483646;
    };

    function generateFullWeakMap() {
      const weakMap = {};
      const seed = 12345;
      const rand = new SeededRandom(seed);
      for (let num = 0; num <= 99; num++) {
        let d1 = Math.floor(rand.random() * 9) + 1;
        let d2 = Math.floor(rand.random() * 9) + 1;
        if (d1 === d2) d2 = d1 === 9 ? 1 : d1 + 1;
        const key = num.toString().padStart(2, '0');
        weakMap[key] = [d1, d2];
      }
      weakMap['28'] = [3, 4];
      weakMap['82'] = [1, 2];
      return weakMap;
    }

    const fullWeakMap = generateFullWeakMap();
    let savedData = {};
    let selectedMarket = null;

    // === UTILITAS ===
    function showStatus(text, type = "") {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = "status " + type;
    }

    function salinTeks(teks) {
      if (!teks || teks === '-' || teks.includes('Klik "Cari"')) return showStatus("‚ÑπÔ∏è Tidak ada data.", true);
      if (navigator.clipboard) {
        navigator.clipboard.writeText(teks).then(() => {
          showStatus("‚úÖ Disalin!", false);
        }).catch(() => showStatus("‚ùå Gagal salin.", true));
      }
    }

    function renderSavedList(market) {
      const container = document.getElementById('savedList');
      let html = '<h3>Data Tersimpan</h3>';
      if (Object.keys(savedData).length === 0) {
        html += `<p><em>Tidak ada data tersimpan untuk ${market}.</em></p>`;
      } else {
        html += '<div>';
        Object.entries(savedData).forEach(([key, [d1, d2]]) => {
          html += `
            <div class="saved-item">
              <span><strong>${key}</strong>: ${d1} & ${d2}</span>
              <button onclick="useSaved('${key}')">Pakai</button>
            </div>
          `;
        });
        html += '</div>';
      }
      container.innerHTML = html;
    }

    window.useSaved = function(key) {
      if (!savedData[key]) return;
      const [d1, d2] = savedData[key];
      document.getElementById('show2D').textContent = key;
      document.getElementById('showDasar').textContent = `${d1} & ${d2}`;
      document.getElementById('resultBox').style.display = 'block';
      showStatus(`‚úÖ Data ${key} dimuat.`, "success");
    };

    function getKop2D(resultSebelum, resultSekarang) {
      if (resultSebelum.length !== 4 || resultSekarang.length !== 4) return null;
      return resultSebelum[1] + resultSekarang[1];
    }

    async function loadLatestTwoResFromRumah1(database, market) {
      if (!market) return;
      try {
        const snapshot = await database.ref(`rumah1/${market}/data`).once('value');
        const data = snapshot.val();
        if (!Array.isArray(data) || data.length < 2) {
          showStatus("‚ÑπÔ∏è Data rumah1 kurang dari 2 baris.", "error");
          return;
        }
        const validRows = data.filter(row => row && row[1] && /^\d{4}$/.test(row[1]));
        if (validRows.length < 2) {
          showStatus("‚ÑπÔ∏è Kurang dari 2 result valid di rumah1.", "error");
          return;
        }
        const prev = validRows[validRows.length - 2][1];
        const curr = validRows[validRows.length - 1][1];
        document.getElementById('resultSebelum').value = prev;
        document.getElementById('resultSekarang').value = curr;
        showStatus("‚úÖ 2 result terakhir dari rumah1 dimuat.", "success");
      } catch (err) {
        console.error("Gagal muat dari rumah1:", err);
        showStatus("‚ö†Ô∏è Gagal muat data dari rumah1.", "error");
      }
    }

    async function loadSavedData(database, market) {
      try {
        const snapshot = await database.ref(`rumah2/${market}`).once('value');
        savedData = snapshot.val() || {};
        renderSavedList(market);
      } catch (err) {
        console.warn("Gagal muat data tersimpan:", err);
      }
    }

    // === INISIALISASI ===
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof firebase === 'undefined' || !firebase.apps.length) {
        showStatus("‚ö†Ô∏è Firebase tidak dimuat.", "error");
        return;
      }
      const database = firebase.database();

      const marketSelect = document.getElementById('marketSelect');
      const resultSebelum = document.getElementById('resultSebelum');
      const resultSekarang = document.getElementById('resultSekarang');
      const btnCari = document.getElementById('btnCari');
      const btnEdit = document.getElementById('btnEdit');
      const btnSimpan = document.getElementById('btnSimpan');
      const btnHapus = document.getElementById('btnHapus');
      const btnMuatDariRumah1 = document.getElementById('btnMuatDariRumah1');
      const btnSalinRangkuman = document.getElementById('btnSalinRangkuman');
      const marketStatusEl = document.getElementById('market-status');

      [resultSebelum, resultSekarang].forEach(el => {
        el.addEventListener('input', () => {
          el.value = el.value.replace(/[^0-9]/g, '').slice(0, 4);
        });
      });

      btnSalinRangkuman.addEventListener('click', () => {
        salinTeks(document.getElementById('rangkumanTidakLemah').textContent);
      });

      const marketAktif = localStorage.getItem('marketAktif');
      if (marketAktif) {
        marketSelect.value = marketAktif;
        selectedMarket = marketAktif;
        marketStatusEl.textContent = `üìä Market aktif: ${marketAktif}`;
        loadSavedData(database, marketAktif);
      } else {
        marketStatusEl.textContent = "‚ö†Ô∏è Tidak ada market aktif.";
        marketStatusEl.style.color = "#ef4444";
      }

      marketSelect.addEventListener('change', () => {
        selectedMarket = marketSelect.value;
        if (selectedMarket) {
          localStorage.setItem('marketAktif', selectedMarket);
          marketStatusEl.textContent = `üìä Market aktif: ${selectedMarket}`;
          loadSavedData(database, selectedMarket);
        } else {
          marketStatusEl.textContent = "‚ö†Ô∏è Pilih market terlebih dahulu.";
          document.getElementById('savedList').innerHTML = '<h3>Data Tersimpan</h3><p><em>Pilih market untuk memuat data.</em></p>';
          savedData = {};
        }
      });

      btnMuatDariRumah1.addEventListener('click', () => {
        if (!selectedMarket) return showStatus("‚ö†Ô∏è Pilih market dulu.", "error");
        loadLatestTwoResFromRumah1(database, selectedMarket);
      });

      // === LOGIKA UTAMA: HANYA BERDASARKAN HASIL GENERATOR SAAT INI ===
      btnCari.addEventListener('click', () => {
        const market = marketSelect.value;
        if (!market) return showStatus("‚ö†Ô∏è Pilih market.", "error");
        const r1 = resultSebelum.value.trim();
        const r2 = resultSekarang.value.trim();
        if (r1.length !== 4 || r2.length !== 4) return showStatus("‚ö†Ô∏è Masukkan dua result 4D.", "error");
        const key2D = getKop2D(r1, r2);
        if (!key2D || !fullWeakMap[key2D]) return showStatus("‚ùå Kombinasi kop tidak valid.", "error");

        const [d1, d2] = fullWeakMap[key2D];
        document.getElementById('show2D').textContent = key2D;
        document.getElementById('showDasar').textContent = `${d1} & ${d2}`;
        document.getElementById('resultBox').style.display = 'block';
        selectedMarket = market;
        showStatus("‚úÖ Dasar lemah siap.", "success");

        // === HITUNG RANGKUMAN DASAR KUAT ===
        const dasarLemah = new Set([d1, d2]);
        const semua2D = [];
        for (let i = 0; i <= 99; i++) {
          const num = i.toString().padStart(2, '0');
          const dasar = hitungDasar2D(i);
          if (!dasarLemah.has(dasar)) {
            semua2D.push(num);
          }
        }
        const teks = semua2D.length ? semua2D.join('*') + '#' : '-';
        document.getElementById('rangkumanTidakLemah').textContent = teks;
      });

      // === SIMPAN/EDIT/HAPUS (HANYA UNTUK HISTORI, TIDAK PENGARUHI RANGKUMAN) ===
      btnSimpan.addEventListener('click', () => {
        if (!document.getElementById('show2D').textContent || !selectedMarket) {
          return showStatus("‚ö†Ô∏è Tidak ada hasil untuk disimpan.", "error");
        }
        const key2D = document.getElementById('show2D').textContent;
        const dasarText = document.getElementById('showDasar').textContent;
        const [d1, d2] = dasarText.split(' & ').map(Number);
        firebase.database().ref(`rumah2/${selectedMarket}/${key2D}`).set([d1, d2])
          .then(() => {
            savedData[key2D] = [d1, d2];
            renderSavedList(selectedMarket);
            showStatus("‚úÖ Tersimpan ke cloud!", "success");
          })
          .catch(err => showStatus("‚ùå Gagal simpan.", "error"));
      });

      btnEdit.addEventListener('click', () => {
        const key2D = document.getElementById('show2D').textContent;
        if (!key2D || !selectedMarket) return showStatus("‚ÑπÔ∏è Tidak ada data.", "error");
        const newData = prompt(`Edit dasar lemah untuk ${key2D} (format: d1,d2)`);
        if (newData) {
          const [d1, d2] = newData.split(',').map(s => parseInt(s.trim()));
          if (d1 >= 1 && d1 <= 9 && d2 >= 1 && d2 <= 9 && d1 !== d2) {
            firebase.database().ref(`rumah2/${selectedMarket}/${key2D}`).set([d1, d2])
              .then(() => {
                document.getElementById('showDasar').textContent = `${d1} & ${d2}`;
                savedData[key2D] = [d1, d2];
                renderSavedList(selectedMarket);
                showStatus("‚úÖ Diperbarui.", "success");
              });
          } else {
            alert("Dasar harus 1‚Äì9 dan berbeda.");
          }
        }
      });

      btnHapus.addEventListener('click', () => {
        const key2D = document.getElementById('show2D').textContent;
        if (!key2D || !savedData[key2D]) return showStatus("‚ÑπÔ∏è Tidak ada data cloud.", "error");
        if (!confirm(`Hapus ${key2D}?`)) return;
        firebase.database().ref(`rumah2/${selectedMarket}/${key2D}`).remove()
          .then(() => {
            delete savedData[key2D];
            renderSavedList(selectedMarket);
            showStatus("üóëÔ∏è Dihapus.", "success");
          })
          .catch(err => showStatus("‚ùå Gagal hapus.", "error"));
      });
    });
  </script>
</body>
</html>
