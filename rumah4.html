<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kelompok</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --accent2: #a78bfa;
      --danger: #ef4444;
      --ok: #10b981;
    }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 20% 20%, #0b1324, #0a1020 60%, #070b18);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      line-height: 1.6;
      padding: 24px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
    }
    .back-home {
      text-align: right;
      margin-bottom: 16px;
    }
    .back-home a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    h2 {
      text-align: center;
      font-size: 1.6rem;
      margin: 0 0 20px;
      letter-spacing: 0.2px;
    }
    #market-status {
      text-align: center;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 16px;
    }
    .card {
      background: linear-gradient(180deg, #121826, #0f1624);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }
    input[type="text"],
    select {
      width: 100%;
      background: #0c1220;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s ease;
    }
    input[type="text"]::placeholder {
      color: #6b7280;
    }
    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.12);
    }
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #0b1020;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }
    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    .btn-secondary {
      background: #0c1220;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .btn-edit { background: linear-gradient(90deg, #FF9800, #FFB347); color: #0b1020; }
    .btn-delete { background: linear-gradient(90deg, var(--danger), #f87171); color: #0b1020; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #0c1220;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .digit {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: linear-gradient(180deg, #12192a, #0d1424);
      border: 1px solid rgba(255,255,255,0.08);
      font-weight: 800;
      font-size: 1.15rem;
      color: var(--text);
    }
    .angka {
      word-break: break-all;
      font-family: monospace;
      margin: 12px 0;
      line-height: 1.5;
      font-size: 0.95rem;
    }
    .kamar-box {
      margin-top: 16px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      background: rgba(0,0,0,0.2);
    }
    .kamar-title {
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--accent);
    }
    .status {
      text-align: center;
      min-height: 24px;
      margin: 12px 0;
      font-weight: 600;
    }
    .success { color: var(--ok); }
    .error { color: var(--danger); }
    .btn-salin {
      background: linear-gradient(90deg, var(--ok), #34d399);
      color: #0b1020;
      padding: 6px 12px;
      font-size: 0.9rem;
      margin-top: 8px;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 36px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back-home">
      <a href="index.html">‚Üê Kembali ke Beranda</a>
    </div>

    <h2>Kelompok</h2>
    <div id="market-status"></div>

    <div class="card">
      <div style="margin-bottom: 16px;">
        <label for="market">Pilih Market</label>
        <select id="market">
          <option value="">-- Pilih Market --</option>
          <option value="Cambodia">Cambodia</option>
          <option value="Sidney">Sidney</option>
          <option value="China">China</option>
          <option value="Japan">Japan</option>
          <option value="SGP">SGP</option>
          <option value="Taiwan">Taiwan</option>
          <option value="Hongkong">Hongkong</option>
        </select>
      </div>

      <div style="margin-bottom: 16px;">
        <label for="input4D">Input 4D (contoh: 1234)</label>
        <input type="text" id="input4D" placeholder="Contoh: 1234" maxlength="4" />
      </div>

      <div class="btn-row">
        <button id="btnCari">Cari</button>
        <button class="btn-secondary" id="btnEdit">Edit</button>
        <button id="btnSimpan">Simpan ke Cloud</button>
        <button class="btn-delete" id="btnHapus">Hapus dari Cloud</button>
        <button id="btnMuatDariRumah1" class="btn-secondary">Muat dari rumah1</button>
      </div>

      <div id="status" class="status"></div>
    </div>

    <div id="hasil" class="card" style="display: none;">
      <h3>Hasil Kelompok</h3>
      <div id="hasilContent"></div>
    </div>
  </div>

  <!-- Firebase SDK - DIPERBAIKI: HAPUS SPASI -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="./config-firebase.js"></script>

  <script>
    // === DATA STATIS ===
    const pasanganKamar = {
      "00":[1,2],"11":[1,3],"22":[2,3],"33":[1,2],"44":[1,3],"55":[2,3],"66":[1,2],"77":[1,3],"88":[2,3],"99":[1,2],
      "01":[1,2],"10":[2,3],"02":[1,3],"20":[1,2],"03":[2,3],"30":[1,3],"04":[1,2],"40":[1,3],"05":[2,3],"50":[1,2],
      "06":[1,3],"60":[2,3],"07":[1,2],"70":[2,3],"08":[2,3],"80":[1,3],"09":[1,3],"90":[1,2],"12":[1,3],"21":[2,3],
      "13":[2,3],"31":[1,2],"14":[1,2],"41":[2,3],"15":[1,3],"51":[1,2],"16":[2,3],"61":[1,3],"17":[1,2],"71":[1,3],
      "18":[1,3],"81":[2,3],"19":[2,3],"91":[1,2],"23":[1,2],"32":[1,3],"24":[2,3],"42":[1,2],"25":[1,3],"52":[2,3],
      "26":[1,2],"62":[1,3],"27":[2,3],"72":[1,2],"28":[1,3],"82":[2,3],"29":[1,2],"92":[1,3],"34":[2,3],"43":[1,2],
      "35":[1,3],"53":[2,3],"36":[1,2],"63":[1,3],"37":[2,3],"73":[1,2],"38":[1,3],"83":[2,3],"39":[1,2],"93":[1,3],
      "45":[2,3],"54":[1,3],"46":[1,2],"64":[2,3],"47":[1,3],"74":[1,2],"48":[2,3],"84":[1,3],"49":[1,2],"94":[2,3],
      "56":[1,3],"65":[1,2],"57":[2,3],"75":[1,3],"58":[1,2],"85":[2,3],"59":[1,3],"95":[1,2],"67":[2,3],"76":[1,3],
      "68":[1,2],"86":[1,3],"69":[1,3],"96":[2,3],"78":[2,3],"87":[1,2],"79":[1,3],"97":[2,3],"89":[1,2],"98":[1,3]
    };

    const shioKeKamar = {1:1,4:1,7:1,10:1, 2:2,5:2,8:2,11:2, 3:3,6:3,9:3,12:3};
    const kamar2D = {1:[],2:[],3:[]};
    for (let n = 0; n <= 99; n++) {
      const num = String(n).padStart(2, '0');
      const shio = (n % 12 === 0) ? 12 : (n % 12);
      kamar2D[shioKeKamar[shio]].push(num);
    }

    // === STATE ===
    let currentData = null;
    let currentKey = null;
    let selectedMarket = null;

    // === FUNGSI BANTUAN ===
    function showStatus(text, type = "") {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = "status " + type;
    }

    function salinTeks(teks) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(teks).then(() => {
          showStatus("‚úÖ Disalin ke clipboard!", "success");
        }).catch(() => {
          showStatus("‚ùå Gagal menyalin.", "error");
        });
      } else {
        showStatus("‚ùå Clipboard tidak didukung.", "error");
      }
    }

    function renderHasil(kopAs2D, kamar) {
      const [k1, k2] = kamar;
      const shioText = (k) => k === 1 ? "1,4,7,10" : k === 2 ? "2,5,8,11" : "3,6,9,12";
      const html = `
        <div><strong>Kop-As: ${kopAs2D} ‚Üí Pasangan Kamar: ${k1}, ${k2}</strong></div>
        <div class="kamar-box">
          <div class="kamar-title">Kamar ${k1}: shio ${shioText(k1)}</div>
          <div class="angka" id="angka1">${kamar2D[k1].join('*')}</div>
          <button class="btn-salin" data-copy="${kamar2D[k1].join('*')}">Salin</button>
        </div>
        <div class="kamar-box">
          <div class="kamar-title">Kamar ${k2}: shio ${shioText(k2)}</div>
          <div class="angka" id="angka2">${kamar2D[k2].join('*')}</div>
          <button class="btn-salin" data-copy="${kamar2D[k2].join('*')}">Salin</button>
        </div>
      `;
      document.getElementById('hasilContent').innerHTML = html;
      document.getElementById('hasil').style.display = 'block';

      document.querySelectorAll('.btn-salin').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const teks = e.target.getAttribute('data-copy');
          salinTeks(teks);
        });
      });
    }

    // === MUAT 1 RES TERAKHIR DARI rumah1 ===
    async function loadLatestResFromRumah1(database, market) {
      if (!market) return;
      try {
        const snapshot = await database.ref(`rumah1/${market}/data`).once('value');
        const data = snapshot.val();
        if (!Array.isArray(data) || data.length < 1) {
          showStatus("‚ÑπÔ∏è Tidak ada data di rumah1.", "error");
          return;
        }
        const validRows = data.filter(row => row && row[1] && /^\d{4}$/.test(row[1]));
        if (validRows.length < 1) {
          showStatus("‚ÑπÔ∏è Tidak ada result valid di rumah1.", "error");
          return;
        }
        const lastRes = validRows[validRows.length - 1][1];
        document.getElementById('input4D').value = lastRes;
        showStatus("‚úÖ Result terakhir dari rumah1 dimuat.", "success");
      } catch (err) {
        console.error("Gagal muat dari rumah1:", err);
        showStatus("‚ö†Ô∏è Gagal muat data dari rumah1.", "error");
      }
    }

    // === INISIALISASI DOM ===
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof firebase === 'undefined' || !firebase.apps.length) {
        showStatus("‚ö†Ô∏è Firebase tidak dimuat.", "error");
        return;
      }
      const database = firebase.database();

      const marketSelect = document.getElementById('market');
      const input4D = document.getElementById('input4D');
      const btnCari = document.getElementById('btnCari');
      const btnEdit = document.getElementById('btnEdit');
      const btnSimpan = document.getElementById('btnSimpan');
      const btnHapus = document.getElementById('btnHapus');
      const btnMuatDariRumah1 = document.getElementById('btnMuatDariRumah1');
      const marketStatusEl = document.getElementById('market-status');

      input4D.addEventListener('input', () => {
        input4D.value = input4D.value.replace(/[^0-9]/g, '').slice(0, 4);
      });

      // Baca market aktif dari localStorage
      const marketAktif = localStorage.getItem('marketAktif');
      if (marketAktif) {
        marketSelect.value = marketAktif;
        selectedMarket = marketAktif;
        marketStatusEl.textContent = `üìä Market aktif: ${marketAktif}`;
      } else {
        marketStatusEl.textContent = "‚ö†Ô∏è Tidak ada market aktif. Kembali ke beranda untuk pilih.";
        marketStatusEl.style.color = "#ef4444";
      }

      marketSelect.addEventListener('change', () => {
        selectedMarket = marketSelect.value;
        if (selectedMarket) {
          localStorage.setItem('marketAktif', selectedMarket);
          marketStatusEl.textContent = `üìä Market aktif: ${selectedMarket}`;
          loadLatestData(database, selectedMarket);
        } else {
          marketStatusEl.textContent = "‚ö†Ô∏è Pilih market terlebih dahulu.";
          document.getElementById('hasil').style.display = 'none';
          currentKey = null;
          currentData = null;
        }
      });

      // Muat dari rumah1
      btnMuatDariRumah1.addEventListener('click', () => {
        if (!selectedMarket) {
          showStatus("‚ö†Ô∏è Pilih market terlebih dahulu.", "error");
          return;
        }
        loadLatestResFromRumah1(database, selectedMarket);
      });

      btnCari.addEventListener('click', () => {
        const market = marketSelect.value;
        if (!market) {
          showStatus("‚ö†Ô∏è Pilih market terlebih dahulu.", "error");
          return;
        }
        const raw = input4D.value.trim();
        if (raw.length !== 4 || !/^\d{4}$/.test(raw)) {
          showStatus("‚ö†Ô∏è Masukkan 4 digit angka!", "error");
          return;
        }

        const as = raw[0];
        const kop = raw[1];
        const kopAs2D = kop + as;

        if (!pasanganKamar[kopAs2D]) {
          showStatus("‚ùå Kombinasi kop-as tidak dikenali.", "error");
          return;
        }

        const kamar = pasanganKamar[kopAs2D];
        renderHasil(kopAs2D, kamar);

        currentData = {
          input4D: raw,
          kopAs2D: kopAs2D,
          kamar: kamar,
          market: market
          // TIDAK simpan timestamp di sini ‚Üí simpan langsung saat push
        };
        selectedMarket = market;
        showStatus("‚úÖ Hasil siap.", "success");
      });

      btnEdit.addEventListener('click', () => {
        if (currentData) {
          input4D.value = currentData.input4D;
          marketSelect.value = currentData.market;
          selectedMarket = currentData.market;
          marketStatusEl.textContent = `üìä Market aktif: ${selectedMarket}`;
          showStatus("‚úèÔ∏è Edit input, lalu klik Cari.", "success");
        } else {
          showStatus("‚ÑπÔ∏è Tidak ada data untuk diedit.", "error");
        }
      });

      btnSimpan.addEventListener('click', () => {
        if (!currentData || !selectedMarket) {
          showStatus("‚ö†Ô∏è Tidak ada data untuk disimpan.", "error");
          return;
        }
        // ‚úÖ Gunakan server timestamp saat push
        const dataToSave = {
          ...currentData,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        const ref = database.ref(`rumah4/${selectedMarket}`).push();
        ref.set(dataToSave).then(() => {
          currentKey = ref.key;
          showStatus("‚úÖ Data tersimpan ke cloud!", "success");
        }).catch(err => {
          console.error("Simpan error:", err);
          showStatus("‚ùå Gagal simpan: cek koneksi.", "error");
        });
      });

      btnHapus.addEventListener('click', () => {
        if (!currentKey || !selectedMarket) {
          showStatus("‚ÑπÔ∏è Tidak ada data cloud untuk dihapus.", "error");
          return;
        }
        if (!confirm(`Hapus data untuk market "${selectedMarket}"?`)) return;
        database.ref(`rumah4/${selectedMarket}/${currentKey}`).remove()
          .then(() => {
            currentKey = null;
            currentData = null;
            document.getElementById('hasil').style.display = 'none';
            showStatus("üóëÔ∏è Data dihapus dari cloud.", "success");
          })
          .catch(err => {
            console.error("Hapus error:", err);
            showStatus("‚ùå Gagal hapus: cek koneksi.", "error");
          });
      });

      if (marketAktif) {
        setTimeout(() => loadLatestData(database, marketAktif), 300);
      }
    });

    async function loadLatestData(database, market) {
      try {
        const snapshot = await database.ref(`rumah4/${market}`)
          .orderByChild("timestamp")
          .limitToLast(1)
          .once("value");

        if (snapshot.exists()) {
          const dataObj = snapshot.val();
          const key = Object.keys(dataObj)[0];
          const data = dataObj[key];

          document.getElementById('input4D').value = data.input4D;
          currentData = data;
          currentKey = key;

          renderHasil(data.kopAs2D, data.kamar);
          showStatus(`‚úÖ Data termuat untuk market: ${market}`, "success");
        }
      } catch (err) {
        console.warn("Gagal muat data:", err);
        showStatus("‚ö†Ô∏è Gagal muat data dari cloud.", "error");
      }
    }
  </script>
</body>
</html>
