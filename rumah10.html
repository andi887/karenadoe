<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>kamar10</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      padding: 16px;
      line-height: 1.5;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 16px;
      padding: 10px 20px;
      background: #2ecc71;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .back-btn:hover {
      background: #27ae60;
    }
    .feature-label {
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.3em;
    }
    #market-status {
      text-align: center;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 10px;
    }
    .card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }
    .table-container {
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 10px;
      border-radius: 4px;
      background: white;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      min-width: 850px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f9;
      position: sticky;
      top: 0;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      border: 1px solid transparent;
      outline: none;
      padding: 6px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      border-color: #2196F3;
      background-color: #f9f9f9;
    }
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    button {
      padding: 8px 14px;
      font-size: 0.9em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
    }
    button:active {
      transform: scale(0.98);
    }
    .add-row-btn { background-color: #FF9800; color: white; }
    .save-firebase-btn { background-color: #4CAF50; color: white; }
    .delete-btn {
      background-color: #f44336;
      color: white;
      padding: 4px 8px;
      font-size: 0.8em;
    }
    .input-error { 
      color: #d32f2f; 
      font-weight: bold; 
      background-color: #ffebee;
    }
    #status {
      text-align: center;
      margin: 8px 0;
      min-height: 20px;
      font-weight: bold;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: center; }
      button { width: 100%; max-width: 200px; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">‚Üê Kembali ke Beranda</a>
  <div class="feature-label">kamar10</div>

  <div class="card">
    <label for="marketSelect">Pilih Market</label>
    <select id="marketSelect">
      <option value="">-- Pilih Market --</option>
      <option value="Cambodia">Cambodia</option>
      <option value="Sidney">Sidney</option>
      <option value="China">China</option>
      <option value="Japan">Japan</option>
      <option value="SGP">SGP</option>
      <option value="Taiwan">Taiwan</option>
      <option value="Hongkong">Hongkong</option>
      <option value="Nusa">Nusa</option>
    </select>
  </div>

  <div id="market-status"></div>
  <div id="status"></div>

  <div class="table-container">
    <table id="kamar10-table">
      <thead>
        <tr>
          <th>tgl</th>
          <th>res</th>
          <th>1</th>
          <th>2</th>
          <th>3</th>
          <th>4</th>
          <th>5</th>
          <th>6</th>
          <th>7</th>
          <th>8</th>
          <th>9</th>
          <th>10</th>
          <th>11</th>
          <th>12</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <div class="controls">
    <button class="add-row-btn" id="add-row">Tambah Baris</button>
    <button class="save-firebase-btn" id="save-firebase">Simpan ke Firebase</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="./config-firebase.js"></script>

  <script>
    // === FUNGSI BANTU ===
    function formatTanggalInput(inputElement) {
      inputElement.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 4) value = value.slice(0, 4);
        if (value.length >= 2) {
          value = value.slice(0, 2) + '/' + value.slice(2);
        }
        e.target.value = value;
      });
    }

    function showStatus(msg, isSuccess = true) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      statusEl.className = isSuccess ? 'success' : 'error';
      setTimeout(() => statusEl.textContent = '', 3000);
    }

    // === HITUNG RUMUS LEMAH (COPY-PASTE 100% DARI RUMAH3) ===
    function hitungRumusLemah(tglSeb, tglSkr, resSebelum, resSekarang) {
      const kamarRumus = {};
      for (let i = 1; i <= 12; i++) kamarRumus[i] = new Set();

      let str4D = resSekarang.toString().padStart(4, '0');
      const AS = +str4D[0], KOP = +str4D[1], KEPALA = +str4D[2], EKOR = +str4D[3], duaD = KEPALA * 10 + EKOR;
      let str4DLalu = resSebelum.toString().padStart(4, '0');
      const AS_Lalu = +str4DLalu[0];

      // Fungsi bantu lokal
      function angkaKeShio(n) { n = n % 12; return n === 0 ? 12 : n; }
      function getIndex(angka) { return (angka + 5) % 10; }
      function hitungDasar2D(duaD) {
        let total = duaD < 10 ? duaD : parseInt(duaD.toString()[0]) + parseInt(duaD.toString()[1]);
        while (total >= 10) total = String(total).split('').reduce((sum, d) => sum + parseInt(d), 0);
        return total === 0 ? 9 : total;
      }

      const shioAngka = {
        1: [1,13,25,37,49,61,73,85,97],
        2: [2,14,26,38,50,62,74,86,98],
        3: [3,15,27,39,51,63,75,87,99],
        4: [4,16,28,40,52,64,76,88],
        5: [5,17,29,41,53,65,77,89],
        6: [6,18,30,42,54,66,78,90],
        7: [7,19,31,43,55,67,79,91],
        8: [8,20,32,44,56,68,80,92],
        9: [9,21,33,45,57,69,81,93],
        10: [10,22,34,46,58,70,82,94],
        11: [11,23,35,47,59,71,83,95],
        12: [12,24,36,48,60,72,84,96]
      };

      kamarRumus[angkaKeShio(tglSkr)].add(1);
      kamarRumus[angkaKeShio(tglSkr + 7)].add(2);
      kamarRumus[angkaKeShio(tglSeb + tglSkr)].add(3);
      kamarRumus[angkaKeShio(hitungDasar2D(duaD) + tglSkr)].add(4);
      kamarRumus[angkaKeShio(100 - duaD)].add(5);
      kamarRumus[angkaKeShio(99 - duaD)].add(6);
      kamarRumus[angkaKeShio(getIndex(AS) * 10 + getIndex(KOP))].add(7);
      kamarRumus[angkaKeShio(getIndex(KEPALA) * 10 + getIndex(EKOR))].add(8);
      kamarRumus[angkaKeShio(AS * 10 + KOP)].add(9);
      kamarRumus[angkaKeShio(KOP * 10 + KEPALA)].add(10);

      const digitKepala = KEPALA.toString();
      for (let s = 1; s <= 12; s++) {
        if (!shioAngka[s].some(num => num.toString().padStart(2, '0').includes(digitKepala)))
          kamarRumus[s].add(11);
      }

      const digitEkor = EKOR.toString();
      for (let s = 1; s <= 12; s++) {
        if (!shioAngka[s].some(num => num.toString().padStart(2, '0').includes(digitEkor)))
          kamarRumus[s].add(12);
      }

      kamarRumus[angkaKeShio(AS * 10 + EKOR)].add(13);
      kamarRumus[angkaKeShio(getIndex(AS_Lalu) * 10 + getIndex(AS))].add(14);

      let str4DLalu6 = resSebelum.toString().padStart(4, '0');
      let str4DSkr6 = resSekarang.toString().padStart(4, '0');
      const combined8 = str4DLalu6 + str4DSkr6;
      const result6 = combined8.slice(-6).padStart(6, '0');

      let sum15 = 0;
      for (const char of result6) sum15 += parseInt(char, 10);
      sum15 += 9;
      const target2D_15 = String(sum15).padStart(2, '0').slice(-2);
      const angka15 = parseInt(target2D_15, 10);
      kamarRumus[angkaKeShio(angka15)].add(15);

      const ac2D = result6[0] + result6[2];
      const angka16 = parseInt(ac2D, 10);
      kamarRumus[angkaKeShio(angka16)].add(16);

      let sum17 = 0;
      for (const char of result6) sum17 += parseInt(char, 10);
      const mod17 = sum17 % 12;
      const shio17 = mod17 === 0 ? 12 : mod17;
      kamarRumus[shio17].add(17);

      return kamarRumus;
    }

    // === TAMPILKAN HASIL DI TABEL ===
    function tampilkanHasil(row, kamarRumus) {
      const cells = row.querySelectorAll('td input');
      for (let i = 2; i <= 13; i++) {
        cells[i].value = "‚úì";
        cells[i].classList.remove('input-error');
      }

      for (let shio = 1; shio <= 12; shio++) {
        const rumusList = Array.from(kamarRumus[shio]).sort((a, b) => a - b);
        if (rumusList.length > 0) {
          cells[shio + 1].value = rumusList.join(",");
          cells[shio + 1].classList.add('input-error');
        }
      }
    }

    // === PERHITUNGAN BARIS ===
    function calculateRow(targetRow) {
      const tbody = targetRow.parentElement;
      const allRows = Array.from(tbody.querySelectorAll('tr'));
      const targetIndex = allRows.indexOf(targetRow);
      if (targetIndex === 0) return;

      const sourceRow = allRows[targetIndex - 1];
      const resSebelum = sourceRow.querySelectorAll('td input')[1]?.value || '';
      const resSekarang = targetRow.querySelectorAll('td input')[1]?.value || '';
      const tglSebelum = sourceRow.querySelectorAll('td input')[0]?.value || '';
      const tglSekarang = targetRow.querySelectorAll('td input')[0]?.value || '';

      if (!resSebelum || !resSekarang || !tglSebelum || !tglSekarang) return;

      const tglSebNum = parseInt(tglSebelum.split('/')[0]);
      const tglSkrNum = parseInt(tglSekarang.split('/')[0]);
      const resSebNum = parseInt(resSebelum);
      const resSkrNum = parseInt(resSekarang);

      if (isNaN(tglSebNum) || isNaN(tglSkrNum) || isNaN(resSebNum) || isNaN(resSkrNum)) return;

      const kamarRumus = hitungRumusLemah(tglSebNum, tglSkrNum, resSebNum, resSkrNum);
      tampilkanHasil(targetRow, kamarRumus);
    }

    function recalculateFrom(startingRow) {
      const tbody = startingRow.parentElement;
      const allRows = Array.from(tbody.querySelectorAll('tr'));
      const startIndex = allRows.indexOf(startingRow);
      for (let i = startIndex; i < allRows.length; i++) {
        calculateRow(allRows[i]);
      }
    }

    // === BUAT BARIS ===
    function createRow() {
      const tr = document.createElement("tr");
      for (let i = 0; i < 14; i++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.setAttribute('autocomplete', 'off');
        if (i === 0) {
          input.maxLength = 5;
          input.placeholder = "DD/MM";
          formatTanggalInput(input);
        } else if (i === 1) {
          input.placeholder = "4D";
          input.maxLength = 4;
        } else {
          input.readOnly = true;
          input.style.backgroundColor = "#f9f9f9";
        }
        td.appendChild(input);
        tr.appendChild(td);
      }

      const actionTd = document.createElement("td");
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Hapus";
      deleteBtn.className = "delete-btn";
      deleteBtn.onclick = function () {
        if (confirm("Hapus baris ini?")) {
          const row = this.closest('tr');
          const next = row.nextElementSibling;
          row.remove();
          if (next) recalculateFrom(next);
          saveDataToFirebase();
        }
      };
      actionTd.appendChild(deleteBtn);
      tr.appendChild(actionTd);

      tr.addEventListener('input', () => {
        if (tr.querySelector('input[placeholder="4D"]')) {
          const resInput = tr.querySelector('input[placeholder="4D"]');
          resInput.value = resInput.value.replace(/[^0-9]/g, '').slice(0, 4);
        }
        recalculateFrom(tr);
      });

      return tr;
    }

    // === FIREBASE ===
    function saveDataToFirebase() {
      const market = document.getElementById('marketSelect').value;
      if (!market) {
        showStatus("‚ö†Ô∏è Pilih market terlebih dahulu.", false);
        return;
      }
      localStorage.setItem('marketAktif', market);

      try {
        const table = document.getElementById('kamar10-table');
        const rows = Array.from(table.querySelectorAll("tbody tr"));
        const data = rows.map(row => Array.from(row.querySelectorAll("input")).map(inp => inp.value));
        const db = firebase.database();
        db.ref(`kamar10/${market}/data`).set(data)
          .then(() => showStatus("‚úì Data disimpan ke Firebase", true))
          .catch(err => {
            console.error("Firebase save error:", err);
            showStatus("‚úó Gagal simpan ke Firebase", false);
          });
      } catch (error) {
        console.error("Save error:", error);
        showStatus("‚úó Error saat menyimpan", false);
      }
    }

    async function loadDataFromFirebase(market) {
      if (!market) {
        const tbody = document.querySelector('#kamar10-table tbody');
        tbody.innerHTML = "";
        tbody.appendChild(createRow());
        return;
      }

      try {
        const db = firebase.database();
        const snapshot = await db.ref(`kamar10/${market}/data`).once('value');
        const tbody = document.querySelector('#kamar10-table tbody');
        tbody.innerHTML = "";

        if (snapshot.exists()) {
          const data = snapshot.val();
          data.forEach(rowData => {
            let safeRowData = [...rowData];
            while (safeRowData.length < 14) safeRowData.push("");
            if (safeRowData.length > 14) safeRowData = safeRowData.slice(0, 14);

            const tr = createRow();
            const inputs = tr.querySelectorAll("input");
            safeRowData.forEach((val, i) => {
              if (inputs[i]) inputs[i].value = val;
            });
            tbody.appendChild(tr);
          });
          const allRows = Array.from(tbody.querySelectorAll('tr'));
          for (let i = 1; i < allRows.length; i++) {
            calculateRow(allRows[i]);
          }
        } else {
          tbody.appendChild(createRow());
        }
      } catch (error) {
        console.error("Load error:", error);
        showStatus("‚úó Gagal memuat data", false);
        const tbody = document.querySelector('#kamar10-table tbody');
        tbody.appendChild(createRow());
      }
    }

    // === INISIALISASI ===
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof firebase === 'undefined' || !firebase.apps.length) {
        showStatus("‚ö†Ô∏è Firebase tidak dimuat", false);
        return;
      }

      const marketSelect = document.getElementById('marketSelect');
      const marketStatusEl = document.getElementById('market-status');

      // Cek data dari rumah3
      const importData = localStorage.getItem('kamar10_import');
      if (importData) {
        const data = JSON.parse(importData);
        marketSelect.value = data.market || 'Cambodia';
        localStorage.setItem('marketAktif', data.market || 'Cambodia');
        marketStatusEl.textContent = `üìä Market aktif: ${data.market || 'Cambodia'}`;

        const tbody = document.querySelector('#kamar10-table tbody');
        tbody.innerHTML = "";

        const row1 = createRow();
        row1.querySelectorAll('input')[0].value = data.tglSebelum + '/01';
        row1.querySelectorAll('input')[1].value = data.resSebelum;
        tbody.appendChild(row1);

        const row2 = createRow();
        row2.querySelectorAll('input')[0].value = data.tglSekarang + '/01';
        row2.querySelectorAll('input')[1].value = data.resSekarang;
        tbody.appendChild(row2);

        setTimeout(() => {
          if (tbody.children.length >= 2) {
            calculateRow(tbody.children[1]);
          }
        }, 100);

        localStorage.removeItem('kamar10_import');
        showStatus("‚úÖ Data dari rumah3 dimuat!", false);
      } else {
        const marketAktif = localStorage.getItem('marketAktif');
        if (marketAktif) {
          marketSelect.value = marketAktif;
          marketStatusEl.textContent = `üìä Market aktif: ${marketAktif}`;
          setTimeout(() => loadDataFromFirebase(marketAktif), 300);
        } else {
          marketStatusEl.textContent = "‚ö†Ô∏è Pilih market terlebih dahulu.";
          marketStatusEl.style.color = "#f44336";
          document.querySelector('#kamar10-table tbody').appendChild(createRow());
        }
      }

      marketSelect.addEventListener('change', () => {
        const market = marketSelect.value;
        if (market) {
          marketStatusEl.textContent = `üìä Market aktif: ${market}`;
          loadDataFromFirebase(market);
        }
      });

      document.getElementById('add-row').addEventListener('click', () => {
        const tbody = document.querySelector('#kamar10-table tbody');
        if (tbody) {
          const newRow = createRow();
          tbody.appendChild(newRow);
        }
      });

      document.getElementById('save-firebase').addEventListener('click', saveDataToFirebase);

      document.addEventListener('input', (e) => {
        if (e.target.matches('input[placeholder="4D"]')) {
          e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
        }
      });
    });
  </script>
</body>
</html>
