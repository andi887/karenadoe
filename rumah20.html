<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>rumah20</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      padding: 16px;
      line-height: 1.5;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 16px;
      padding: 10px 20px;
      background: #2ecc71;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .back-btn:hover {
      background: #27ae60;
    }
    .feature-label {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 1.3em;
    }
    #market-status {
      text-align: center;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 10px;
    }
    .selectors {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 12px 0;
    }
    .selectors select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95em;
    }
    .table-container {
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 10px;
      border-radius: 4px;
      background: white;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      min-width: 920px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f9;
      position: sticky;
      top: 0;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      border: 1px solid transparent;
      outline: none;
      padding: 6px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      border-color: #2196F3;
      background-color: #f9f9f9;
    }
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    button {
      padding: 8px 14px;
      font-size: 0.9em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
    }
    button:active {
      transform: scale(0.98);
    }
    .add-row-btn { background-color: #FF9800; color: white; }
    .save-firebase-btn { background-color: #4CAF50; color: white; }
    .delete-btn {
      background-color: #f44336;
      color: white;
      padding: 4px 8px;
      font-size: 0.8em;
    }
    .input-error { color: red; font-weight: bold; }
    #status {
      text-align: center;
      margin: 8px 0;
      min-height: 20px;
      font-weight: bold;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    @media (max-width: 600px) {
      .controls, .selectors { flex-direction: column; align-items: center; }
      button, .selectors select { width: 100%; max-width: 220px; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">‚Üê Kembali ke Beranda</a>
  <div class="feature-label">rumah20</div>
  <div id="market-status">Pilih market dan hari</div>

  <div class="selectors">
    <select id="market-select">
      <option value="">Pilih Market Jam</option>
      <option value="JAM12.30">JAM12.30</option>
      <option value="JAM15">JAM15</option>
      <option value="JAM16.45C">JAM16.45C</option>
      <option value="JAM1730J">JAM1730J</option>
      <option value="JAM22T">JAM22T</option>
      <option value="JAM0001">JAM0001</option>
    </select>

    <select id="hari-select" disabled>
      <option value="">Pilih Hari</option>
      <option value="Senin">Senin</option>
      <option value="Selasa">Selasa</option>
      <option value="Rabu">Rabu</option>
      <option value="Kamis">Kamis</option>
      <option value="Jumat">Jumat</option>
      <option value="Sabtu">Sabtu</option>
      <option value="Minggu">Minggu</option>
    </select>
  </div>

  <div id="status"></div>

  <div class="table-container">
    <table id="rumah20-table">
      <thead>
        <tr>
          <th>tgl</th>
          <th>res</th>
          <th>B</th>
          <th>C</th>
          <th>D</th>
          <th>G</th>
          <th>H</th>
          <th>I</th>
          <th>J</th>
          <th>K</th>
          <th>R</th>
          <th>Y</th>
          <th>A</th>
          <th>M</th>
          <th>N</th>
          <th>L</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data akan dimuat di sini -->
      </tbody>
    </table>
  </div>

  <div class="controls">
    <button class="add-row-btn" id="add-row">Tambah Baris</button>
    <button class="save-firebase-btn" id="save-firebase">Simpan ke Firebase</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="./config-firebase.js"></script>

  <script>
    // === KONSTANTA KONTROL (SAMA DENGAN RUMAH1) ===
    const KONTROL_B = {1:["1","2","6","7","8","9"],2:["0","2","3","7","8","9"],3:["0","1","3","4","8","9"],4:["0","1","2","4","5","9"],5:["0","1","2","3","5","6"],6:["1","2","3","4","6","7"],7:["2","3","4","5","7","8"],8:["3","4","5","6","8","9"],9:["0","4","5","6","7","9"],0:["1","2","3","4","5","6"]};
    const KONTROL_C = {0:["3","4","5","6","8","9"],1:["0","2","3","4","6","9"],2:["1","2","3","5","6","8"],3:["0","1","2","3","4","9"],4:["1","2","3","6","8","9"],5:["0","1","2","3","4","5","9"],6:["0","2","3","5","6","9"],7:["0","1","2","3","8","9"],8:["2","3","4","6","7","9"],9:["1","2","3","4","5","6"]};
    const KONTROL_G = {0:["0","1","2","7","8","9"],1:["0","1","2","3","8","9"],2:["0","1","2","3","4","9"],3:["0","1","2","3","4","5"],4:["1","2","3","4","5","6"],5:["2","3","4","5","6","7"],6:["3","4","5","6","7","8"],7:["4","5","6","7","8","9"],8:["5","6","7","8","9","0"],9:["6","7","8","9","0","1"]};
    const KONTROL_H = {0:["0","1","2","5","6","7"],1:["1","2","3","6","7","8"],2:["2","3","4","7","8","9"],3:["0","3","4","5","8","9"],4:["0","2","4","5","6","9"],5:["0","1","2","5","6","7"],6:["1","2","3","6","7","8"],7:["2","3","4","7","8","9"],8:["0","3","4","5","8","9"],9:["0","1","4","5","6","9"]};
    const KONTROL_I = {0:["0","2","3","5","6","7"],1:["0","3","4","6","7","9"],2:["0","1","5","6","7","8"],3:["2","5","6","7","8","9"],4:["0","2","3","5","6","7"],5:["0","1","4","7","8","9"],6:["0","1","2","7","8","9"],7:["0","1","2","3","6","9"],8:["0","1","2","3","4","5"],9:["0","3","4","5","7","8"]};
    const KONTROL_J = {0:["4","5","6","7","8","9"],1:["5","6","7","8","9","0"],2:["6","7","8","9","0","1"],3:["7","8","9","0","1","2"],4:["8","9","0","1","2","3"],5:["9","0","1","2","3","4"],6:["0","1","2","3","4","5"],7:["1","2","3","4","5","6"],8:["2","3","4","5","6","7"],9:["3","4","5","6","7","8"]};
    const KONTROL_K = {0:["0","3","4","5","6","9"],1:["0","1","4","5","6","7"],2:["1","2","5","6","7","8"],3:["2","3","6","7","8","9"],4:["0","3","4","7","8","9"],5:["0","1","4","5","8","9"],6:["0","1","2","5","6","9"],7:["0","1","2","3","6","7"],8:["1","2","3","4","7","8"],9:["2","3","4","5","8","9"]};
    const KONTROL_R = {0:["5","6","7","8","9","0"],1:["1","2","3","4","5","6"],2:["7","8","9","0","1","2"],3:["3","4","5","6","7","8"],4:["9","0","1","2","3","4"],5:["5","6","7","8","9","0"],6:["1","2","3","4","5","6"],7:["7","8","9","0","1","2"],8:["3","4","5","6","7","8"],9:["9","0","1","2","3","4"]};
    const KONTROL_Y = {0:["8","9","0","1","2","3"],1:["9","0","1","2","3","4"],2:["0","1","2","3","4","5"],3:["1","2","3","4","5","6"],4:["2","3","4","5","6","7"],5:["3","4","5","6","7","8"],6:["4","5","6","7","8","9"],7:["5","6","7","8","9","0"],8:["6","7","8","9","0","1"],9:["7","8","9","0","1","2"]};
    const KONTROL_A = {1:["0","1","3","6","7"],2:["1","2","3","7","8"],3:["2","3","4","8","9"],4:["0","3","4","5","9"],5:["0","1","4","5","6"],6:["1","2","5","6","7"],7:["2","3","6","7","8"],8:["3","4","7","8","9"],9:["0","4","5","8","9"]};
    const KONTROL_M = {0:["9","0","1","2","3"],1:["8","9","0","1","2"],2:["3","4","5","6","7"],3:["3","4","5","6","7"],4:["5","6","7","8","9"],5:["0","1","2","3","4"],6:["7","8","9","0","1"],7:["2","3","4","5","6"],8:["1","2","3","4","5"],9:["4","5","6","7","8"]};
    const KONTROL_N = {0:["1","4","6","9"],1:["0","2","5","7"],2:["1","3","6","8"],3:["2","4","7","9"],4:["0","3","5","8"],5:["6","4","1","9"],6:["7","5","0","2"],7:["8","6","3","1"],8:["9","7","4","2"],9:["0","8","5","3"]};

    // === FUNGSI PERHITUNGAN (SAMA PERSIS) ===
    // ... [SEMUA FUNGSI calculateKontrolX tetap sama seperti sebelumnya] ...
    // Untuk efisiensi, saya sisipkan semua fungsi di bawah tanpa mengubah logika

    function calculateKontrolB(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 2 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const twoDigitsSource = resSourceValue.slice(-2);
      const d1s = twoDigitsSource[0];
      const d2s = twoDigitsSource[1];
      const sum = parseInt(d1s) + parseInt(d2s);
      let dasar = (sum === 10) ? 1 : (sum % 10);
      const kontrolList = KONTROL_B[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolC(resSourceValue, resTargetValue) {
      const kepalaSource = resSourceValue[2];
      const kontrolList = KONTROL_C[kepalaSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolD(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kop = resSourceValue[1];
      const kepala = resSourceValue[2];
      const sum = parseInt(kop) + parseInt(kepala);
      let dasar = (sum === 10) ? 1 : (sum % 10);
      const kontrolList = KONTROL_B[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolG(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kop = resSourceValue[1];
      const kepala = resSourceValue[2];
      const sum = parseInt(kop) + parseInt(kepala);
      let dasar = (sum === 10) ? 1 : (sum % 10);
      const kontrolList = KONTROL_G[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolH(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepalaSource = resSourceValue[2];
      const kontrolList = KONTROL_H[kepalaSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolI(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 1 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const ekorSource = resSourceValue[resSourceValue.length - 1];
      const kontrolList = KONTROL_I[ekorSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolJ(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 2 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const as = parseInt(resSourceValue[0]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = (as + ekor) % 10;
      const kontrolList = KONTROL_J[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolK(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepala = parseInt(resSourceValue[2]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = (kepala + ekor) % 10;
      const kontrolList = KONTROL_K[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolR(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 1 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const ekorSource = resSourceValue[resSourceValue.length - 1];
      const kontrolList = KONTROL_R[ekorSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolY(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 2 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kop = parseInt(resSourceValue[1]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = (kop + ekor) % 10;
      const kontrolList = KONTROL_Y[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolA(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepala = parseInt(resSourceValue[2]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      let dasar = kepala + ekor;
      while (dasar >= 10) dasar = Math.floor(dasar / 10) + (dasar % 10);
      const kontrolList = KONTROL_A[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolM(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 1 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const ekorSource = resSourceValue[resSourceValue.length - 1];
      const kontrolList = KONTROL_M[ekorSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolN(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepala = parseInt(resSourceValue[2]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = Math.abs(kepala - ekor);
      const kontrolList = KONTROL_N[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    // === UTILITAS ===
    function formatTanggalInput(inputElement) {
      inputElement.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 4) value = value.slice(0, 4);
        if (value.length >= 2) {
          value = value.slice(0, 2) + '/' + value.slice(2);
        }
        e.target.value = value;
      });
    }

    function showStatus(msg, isSuccess = true) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      statusEl.className = isSuccess ? 'success' : 'error';
      setTimeout(() => statusEl.textContent = '', 3000);
    }

    // === LOGIKA TABEL ===
    function calculateRow(targetRow) {
      const tbody = targetRow.parentElement;
      const allRows = Array.from(tbody.querySelectorAll('tr'));
      const targetIndex = allRows.indexOf(targetRow);
      if (targetIndex === 0) return;

      const sourceRow = allRows[targetIndex - 1];
      const resSourceValue = sourceRow.querySelectorAll('td input')[1]?.value || '';
      const resTargetValue = targetRow.querySelectorAll('td input')[1]?.value || '';

      if (!resSourceValue || !resTargetValue) return;

      const inputs = targetRow.querySelectorAll('td input');
      if (inputs.length < 16) return;

      const funcs = [
        null, null,
        calculateKontrolB, calculateKontrolC, calculateKontrolD, calculateKontrolG,
        calculateKontrolH, calculateKontrolI, calculateKontrolJ, calculateKontrolK,
        calculateKontrolR, calculateKontrolY, calculateKontrolA, calculateKontrolM,
        calculateKontrolN
      ];

      for (let i = 2; i <= 14; i++) {
        const result = funcs[i](resSourceValue, resTargetValue);
        inputs[i].value = result.value;
        inputs[i].classList.toggle('input-error', result.isError);
      }
    }

    function recalculateFrom(startingRow) {
      const tbody = startingRow.parentElement;
      const allRows = Array.from(tbody.querySelectorAll('tr'));
      const startIndex = allRows.indexOf(startingRow);
      for (let i = startIndex; i < allRows.length; i++) {
        calculateRow(allRows[i]);
      }
    }

    function createRow() {
      const tr = document.createElement("tr");
      for (let i = 0; i < 16; i++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.setAttribute('autocomplete', 'off');
        if (i === 0) {
          input.maxLength = 5;
          input.placeholder = "DD/MM";
          formatTanggalInput(input);
        } else if (i === 1) {
          input.placeholder = "4D";
          input.maxLength = 4;
        }
        td.appendChild(input);
        tr.appendChild(td);
      }

      const actionTd = document.createElement("td");
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Hapus";
      deleteBtn.className = "delete-btn";
      deleteBtn.addEventListener('click', function () {
        if (confirm("Hapus baris ini?")) {
          const row = this.closest('tr');
          const next = row.nextElementSibling;
          row.remove();
          if (next) recalculateFrom(next);
          saveDataToFirebase();
        }
      });
      actionTd.appendChild(deleteBtn);
      tr.appendChild(actionTd);

      tr.addEventListener('input', () => {
        recalculateFrom(tr);
      });

      return tr;
    }

    // === FIREBASE DENGAN MARKET + HARI ===
    let currentMarket = null;
    let currentHari = null;

    function getFirebasePath() {
      if (!currentMarket || !currentHari) return null;
      return `rumah20/${currentMarket}/${currentHari}/data`;
    }

    function saveDataToFirebase() {
      if (!currentMarket || !currentHari) {
        showStatus("‚ö†Ô∏è Pilih market dan hari terlebih dahulu.", false);
        return;
      }
      try {
        const table = document.getElementById('rumah20-table');
        const rows = Array.from(table.querySelectorAll("tbody tr"));
        const data = rows.map(row => Array.from(row.querySelectorAll("input")).map(inp => inp.value));
        const db = firebase.database();
        db.ref(getFirebasePath()).set(data)
          .then(() => showStatus("‚úì Data disimpan ke Firebase", true))
          .catch(err => {
            console.error("Firebase save error:", err);
            showStatus("‚úó Gagal simpan ke Firebase", false);
          });
      } catch (error) {
        console.error("Save error:", error);
        showStatus("‚úó Error saat menyimpan", false);
      }
    }

    async function loadDataFromFirebase() {
      if (!currentMarket || !currentHari) {
        document.querySelector('#rumah20-table tbody').innerHTML = "";
        document.querySelector('#rumah20-table tbody').appendChild(createRow());
        return;
      }
      try {
        const db = firebase.database();
        const path = getFirebasePath();
        const snapshot = await db.ref(path).once('value');
        const tbody = document.querySelector('#rumah20-table tbody');
        tbody.innerHTML = "";

        if (snapshot.exists()) {
          const data = snapshot.val();
          if (!Array.isArray(data)) {
            console.warn("Data bukan array:", data);
            data = [];
          }
          data.forEach(rowData => {
            let safeRowData = [...rowData];
            if (rowData.length === 15) safeRowData = ["", ...rowData];
            while (safeRowData.length < 16) safeRowData.push("");
            if (safeRowData.length > 16) safeRowData = safeRowData.slice(0, 16);

            const tr = createRow();
            const inputs = tr.querySelectorAll("input");
            safeRowData.forEach((val, i) => {
              if (inputs[i]) inputs[i].value = val;
            });
            tbody.appendChild(tr);
          });
          const allRows = Array.from(tbody.querySelectorAll('tr'));
          for (let i = 1; i < allRows.length; i++) {
            calculateRow(allRows[i]);
          }
        } else {
          tbody.appendChild(createRow());
        }
      } catch (error) {
        console.error("Load error:", error);
        showStatus("‚úó Gagal memuat data", false);
        document.querySelector('#rumah20-table tbody').appendChild(createRow());
      }
    }

    // === INISIALISASI UTAMA ===
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof firebase === 'undefined' || !firebase.apps.length) {
        showStatus("‚ö†Ô∏è Firebase tidak dimuat", false);
        return;
      }

      const marketSelect = document.getElementById('market-select');
      const hariSelect = document.getElementById('hari-select');
      const statusEl = document.getElementById('market-status');

      // Muat dari localStorage
      const savedMarket = localStorage.getItem('rumah20_market') || '';
      const savedHari = localStorage.getItem('rumah20_hari') || '';

      marketSelect.value = savedMarket;
      if (savedMarket) {
        hariSelect.disabled = false;
        hariSelect.value = savedHari;
        if (savedHari) {
          currentMarket = savedMarket;
          currentHari = savedHari;
          statusEl.textContent = `üìä Market: ${savedMarket} ‚Ä¢ Hari: ${savedHari}`;
          loadDataFromFirebase();
        }
      }

      marketSelect.addEventListener('change', () => {
        currentMarket = marketSelect.value;
        currentHari = null;
        hariSelect.value = '';
        hariSelect.disabled = !currentMarket;
        if (currentMarket) {
          localStorage.setItem('rumah20_market', currentMarket);
        }
        statusEl.textContent = currentMarket ? `üìä Market: ${currentMarket}` : "Pilih market dan hari";
        document.querySelector('#rumah20-table tbody').innerHTML = "";
      });

      hariSelect.addEventListener('change', () => {
        currentHari = hariSelect.value;
        if (currentMarket && currentHari) {
          localStorage.setItem('rumah20_hari', currentHari);
          statusEl.textContent = `üìä Market: ${currentMarket} ‚Ä¢ Hari: ${currentHari}`;
          loadDataFromFirebase();
        }
      });

      document.getElementById('add-row').addEventListener('click', () => {
        const tbody = document.querySelector('#rumah20-table tbody');
        const newRow = createRow();
        tbody.appendChild(newRow);
      });

      document.getElementById('save-firebase').addEventListener('click', saveDataToFirebase);
    });
  </script>
</body>
</html>
