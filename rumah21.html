
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>rumah21</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      padding: 16px;
      line-height: 1.5;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 16px;
      padding: 10px 20px;
      background: #2ecc71;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .back-btn:hover {
      background: #27ae60;
    }
    .page-title {
      text-align: center;
      font-size: 1.6em;
      margin: 16px 0;
      color: #2c3e50;
      font-weight: bold;
    }
    .market-select {
      margin: 12px 0;
      text-align: center;
    }
    .market-select label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #444;
    }
    .market-status {
      text-align: center;
      margin-top: 8px;
      font-size: 0.95em;
      color: #4CAF50;
      font-weight: bold;
    }
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    button {
      padding: 10px 16px;
      font-size: 0.95em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .add-row-btn { background-color: #FF9800; color: white; }
    .save-btn { background-color: #4CAF50; color: white; }
    .table-container {
      overflow-x: auto;
      background: white;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin: 20px 0;
    }
    table {
      width: 100%;
      min-width: 650px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 0.95em;
    }
    th {
      background-color: #f1f3f5;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      text-align: center;
      border: none;
      outline: none;
      background: transparent;
      font-size: 0.95em;
      padding: 4px;
    }
    input[type="text"]:focus {
      background-color: #f0f8ff;
    }
    input[readonly] {
      background-color: #f9f9f9 !important;
      color: #666;
    }
    .delete-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }
    .delete-btn:hover {
      opacity: 0.9;
    }
    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: center; }
      button { width: 100%; max-width: 220px; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">← Kembali ke Beranda</a>
  <h1 class="page-title">rumah21 — Modal & Laba</h1>

  <div class="market-select">
    <label for="market">Pilih Market Jam</label>
    <select id="market">
      <option value="JAM12.30">JAM12.30</option>
      <option value="JAM15">JAM15</option>
      <option value="JAM16.45C">JAM16.45C</option>
      <option value="JAM1730J">JAM1730J</option>
      <option value="JAM22T">JAM22T</option>
      <option value="JAM0001">JAM0001</option>
    </select>
    <div class="market-status" id="marketStatus">Market: JAM12.30</div>
  </div>

  <div class="table-container">
    <table id="rumah21-table">
      <thead>
        <tr>
          <th>Ceklis</th>
          <th>tgl</th>
          <th>H/Line</th>
          <th>Tmodal</th>
          <th>Laba</th>
          <th>Hasil</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <!-- Baris akan ditambahkan di sini -->
      </tbody>
    </table>
  </div>

  <div class="controls">
    <button class="add-row-btn" id="add-row">Tambah Baris</button>
    <button class="save-btn" id="save-firebase">Simpan ke Firebase</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="./config-firebase.js"></script>

  <script>
    let currentMarket = 'JAM12.30';

    function formatTanggal(input) {
      input.addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, '');
        if (v.length > 4) v = v.slice(0, 4);
        if (v.length >= 2) v = v.slice(0,2) + '/' + v.slice(2);
        e.target.value = v;
      });
    }

    function calculateHLine(rowIndex) {
      return 71 * (rowIndex + 1);
    }

    function calculateTmodal(hlineValue) {
      const num = parseFloat(hlineValue);
      return isNaN(num) ? '' : (num * 16).toString();
    }

    function calculateHasil(rowIndex) {
      return (rowIndex + 1) * 7000;
    }

    // ✅ RUMUS BARU: Laba = Hasil - Tmodal
    function calculateLaba(hasilValue, tmodalValue) {
      const hasil = parseFloat(hasilValue) || 0;
      const tmodal = parseFloat(tmodalValue) || 0;
      return (hasil - tmodal).toString();
    }

    function createRow(data = [false, '', '', '', '', '']) {
      const tr = document.createElement('tr');
      
      // Ceklis
      const checkTd = document.createElement('td');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = data[0] === true;
      checkTd.appendChild(checkbox);
      tr.appendChild(checkTd);

      // tgl
      const tglTd = document.createElement('td');
      const tglInput = document.createElement('input');
      tglInput.type = 'text';
      tglInput.value = data[1];
      tglInput.maxLength = 5;
      tglInput.placeholder = 'DD/MM';
      formatTanggal(tglInput);
      tglTd.appendChild(tglInput);
      tr.appendChild(tglTd);

      // H/Line
      const hlineTd = document.createElement('td');
      const hlineInput = document.createElement('input');
      hlineInput.type = 'text';
      hlineInput.readOnly = true;
      hlineInput.style.backgroundColor = '#f9f9f9';
      hlineTd.appendChild(hlineInput);
      tr.appendChild(hlineTd);

      // Tmodal
      const tmodalTd = document.createElement('td');
      const tmodalInput = document.createElement('input');
      tmodalInput.type = 'text';
      tmodalInput.readOnly = true;
      tmodalInput.style.backgroundColor = '#f9f9f9';
      tmodalTd.appendChild(tmodalInput);
      tr.appendChild(tmodalTd);

      // ✅ Laba (otomatis, readonly)
      const labaTd = document.createElement('td');
      const labaInput = document.createElement('input');
      labaInput.type = 'text';
      labaInput.readOnly = true;
      labaInput.style.backgroundColor = '#f9f9f9';
      labaTd.appendChild(labaInput);
      tr.appendChild(labaTd);

      // Hasil
      const hasilTd = document.createElement('td');
      const hasilInput = document.createElement('input');
      hasilInput.type = 'text';
      hasilInput.readOnly = true;
      hasilInput.style.backgroundColor = '#f9f9f9';
      hasilTd.appendChild(hasilInput);
      tr.appendChild(hasilTd);

      // Aksi
      const actionTd = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Hapus';
      deleteBtn.className = 'delete-btn';
      deleteBtn.addEventListener('click', () => {
        if (confirm('Hapus baris ini?')) {
          tr.remove();
          updateAllValues();
        }
      });
      actionTd.appendChild(deleteBtn);
      tr.appendChild(actionTd);

      // Referensi
      tr._checkbox = checkbox;
      tr._hlineInput = hlineInput;
      tr._tmodalInput = tmodalInput;
      tr._labaInput = labaInput;
      tr._hasilInput = hasilInput;
      tr._tglInput = tglInput;

      return tr;
    }

    // ✅ Perbarui SEMUA nilai termasuk Laba
    function updateAllValues() {
      const rows = Array.from(document.querySelectorAll('#table-body tr'));
      rows.forEach((row, index) => {
        row._hlineInput.value = calculateHLine(index);
        row._tmodalInput.value = calculateTmodal(row._hlineInput.value);
        row._hasilInput.value = calculateHasil(index);
        // ✅ Hitung Laba dari Hasil dan Tmodal
        row._labaInput.value = calculateLaba(row._hasilInput.value, row._tmodalInput.value);
      });
    }

    function getTableData() {
      const rows = [];
      document.querySelectorAll('#table-body tr').forEach(row => {
        const checkbox = row._checkbox;
        const tgl = row._tglInput.value.trim();
        const hline = row._hlineInput.value;
        const tmodal = row._tmodalInput.value;
        const laba = row._labaInput.value;
        const hasil = row._hasilInput.value;
        
        if (checkbox.checked || tgl) { // Simpan jika ceklis atau tgl ada
          rows.push([
            checkbox.checked,
            tgl,
            hline,
            tmodal,
            laba,
            hasil
          ]);
        }
      });
      return rows;
    }

    function loadFromFirebase() {
      const db = firebase.database();
      const path = `rumah21/${currentMarket}/data`;
      const tbody = document.getElementById('table-body');
      
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#888;">Memuat...</td></tr>';
      
      db.ref(path).once('value')
        .then(snapshot => {
          tbody.innerHTML = '';
          const rawData = snapshot.val() || [];
          if (Array.isArray(rawData)) {
            rawData.forEach(row => {
              const safeRow = [
                row[0] === true,
                row[1] || '',
                '', '', '', '' // Semua diisi ulang otomatis
              ];
              tbody.appendChild(createRow(safeRow));
            });
          }
          updateAllValues(); // ✅ Pastikan semua nilai sesuai urutan
          if (rawData.length === 0) {
            addEmptyRow();
          }
        })
        .catch(err => {
          console.error('Load error:', err);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#f44336;">Gagal memuat data.</td></tr>';
        });
    }

    function addEmptyRow() {
      const tbody = document.getElementById('table-body');
      tbody.appendChild(createRow());
      updateAllValues();
    }

    function saveToFirebase() {
      const data = getTableData();
      if (data.length === 0) {
        alert('Tidak ada data untuk disimpan.');
        return;
      }

      const db = firebase.database();
      const path = `rumah21/${currentMarket}/data`;
      
      db.ref(path).set(data)
        .then(() => alert('✓ Data berhasil disimpan ke Firebase (proyek "sabar")!'))
        .catch(err => {
          console.error('Error:', err);
          alert('✗ Gagal menyimpan: ' + err.message);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const marketSelect = document.getElementById('market');
      const statusEl = document.getElementById('marketStatus');

      const saved = localStorage.getItem('rumah21_market') || 'JAM12.30';
      marketSelect.value = saved;
      currentMarket = saved;
      statusEl.textContent = `Market: ${saved}`;

      marketSelect.addEventListener('change', () => {
        currentMarket = marketSelect.value;
        localStorage.setItem('rumah21_market', currentMarket);
        statusEl.textContent = `Market: ${currentMarket}`;
        loadFromFirebase();
      });

      document.getElementById('add-row').addEventListener('click', addEmptyRow);
      document.getElementById('save-firebase').addEventListener('click', saveToFirebase);

      loadFromFirebase();
    });
  </script>
</body>
</html>
